# workflow名称，显示在Github Actions Tab 中
name: compil on osx

# workflow 执行的条件
on:
  #手动触发工作流程运行
  workflow_dispatch:

# 具体任务
jobs:
  # 名称为build的任务
  build:
    # 声明运行系统
    runs-on: macOS-latest
    environment: Builds
    strategy:
      matrix:
        python-version: [3.9]

    steps:
      - name: 安装 Python ${{ matrix.python-version }}
        uses: actions/setup-python@v2
        with:
          python-version: ${{ matrix.python-version }}

    # 具体步骤
    steps:
      # 拉取本项目源码
      - uses: actions/checkout@v2


      # 安装Xcode
      - name: 安装Xcode
        shell: bash
        run: |
          echo "安装Xcode"
          #sudo xcode-select --switch /Applications/Xcode_13.0.app
          #sudo xcode-select --install

      # 安装buildozer相关依赖
      - name: 安装buildozer相关依赖
        run: |
          #导入的环境变量只在此name下有效
          export PATH=$PATH:/Users/runner/Library/Python/3.9/bin
          export PATH=$PATH:~/.local/bin/
          brew install pkg-config sdl2 sdl2_image sdl2_ttf sdl2_mixer gstreamer autoconf automake libtool
          python3 -m pip install --user --upgrade pip virtualenv kivy-ios Cython buildozer
          brew link libtool


      - uses: actions/cache@v2
        with:
          #buildozer的缓存路径在项目的根目录
          path: .buildozer
          key: ggw4gg45hyywaygg76ir24fsf3455354h65345rt

      - uses: actions/cache@v2
        with:
          #kivy-ios的build路径在项目的根目录
          path: build
          key: sfeggrt6hddggt6rbrdgeegjlu89kl89l89svgeg54dfbjio4
          
      - uses: actions/cache@v2
        with:
          #kivy-ios的dist路径在项目的根目录
          path: dist
          key: sfeggrt6hddggt6rbrdgeegjsfsfseggwwt34tg54655s2gkdwdg45
          
      - name: toolchain
        run: |
          #导入的环境变量只在此name下有效
          export PATH=$PATH:/Users/runner/Library/Python/3.9/bin
          export PATH=$PATH:~/.local/bin/
          ls -a
          toolchain recipes
          #toolchain build libzbar openssl
          #toolchain build python3 kivy
          #toolchain pip3 install pillow pyzbar camera4kivy

      - name: Build with Buildozer
        id: buildozer
        run: |
          cd wico
          #导入的环境变量只在此name下有效
          export PATH=$PATH:/Users/runner/Library/Python/3.9/bin
          export PATH=$PATH:~/.local/bin/
          ls -a
          buildozer ios debug

      - name: Upload artifacts
        uses: actions/upload-artifact@v3
        with:
          name: package
          path: ${{ steps.buildozer.outputs.filename }}